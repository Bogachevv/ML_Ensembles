<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Model</title>

    <style>
        .fitting{
            display: block;
        }

        .model_cp{
            display: none;
        }
    </style>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>

<script>
    function hide(class_name) {
        console.log("Hello world");
        let elms = document.getElementsByClassName(class_name)
        for (let i = 0; i < elms.length; i++){
            elms[i].style.display = 'none';
        }
    }

    function show(class_name) {
        let elms = document.getElementsByClassName(class_name)
        for (let i = 0; i < elms.length; i++){
            elms[i].style.display = 'block';
        }
    }

    function enable_control_panel() {
        hide('fitting');
        show('model_cp');
    }

    function fit_request() {
        console.log('Fit request');
        let req = new XMLHttpRequest();
        let req_url = '{{ url_for("model_fit", model_no=model_no) }}';

        req.open('POST', req_url, true);

        req.onreadystatechange = function (){
            if (req.readyState === XMLHttpRequest.DONE){
                if (req.status === 200){
                    enable_control_panel();
                }
            }
        }

        req.send();
    }

    function fit(){
        let req = new XMLHttpRequest();
        let req_url = '{{ url_for("get_model_status", model_no=model_no) }}';
        console.log(req_url);

        req.open('GET', req_url , true);

        req.onreadystatechange = function (){
            if (req.readyState === XMLHttpRequest.DONE){
                if (req.status === 200){
                    switch (req.responseText) {
                        case 'not_fit': return fit_request();
                        case 'fit': return enable_control_panel();
                    }
                }
                else{
                    console.log('Error: ' + req.status);
                }
            }
        }

        req.send();
    }

    function draw_metainfo() {
        let req = new XMLHttpRequest();
        let req_url = '{{ url_for("get_columns_meta", model_no=model_no) }}';
        console.log(req_url);

        req.open('GET', req_url , true);

        req.onreadystatechange = function () {
            if (req.readyState === XMLHttpRequest.DONE){
                {#console.log(req.responseText);#}

                let meta_info = JSON.parse(req.responseText);

                let meta_info_tb = document.getElementById("metainfo");

                for (let c_name in meta_info){
                    console.log(c_name, ': ', meta_info[c_name]);

                    let elm = document.createElement('p');
                    elm.innerText = c_name + '(' + meta_info[c_name] + ')';

                    meta_info_tb.appendChild(elm);
                }

            }
        }

        req.send();
    }

</script>

<script>
    fit();
</script>

<div class="fitting">
    <h1>Fitting model...</h1>
</div>

<div class="model_cp">
    <h1>Панель управления: </h1>
    <div id="metainfo"></div>
    <script>
        draw_metainfo();
    </script>
</div>

</body>
</html>